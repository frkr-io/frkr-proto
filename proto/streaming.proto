syntax = "proto3";

package frkr.v1;

option go_package = "github.com/frkr-io/frkr-proto/proto";

// StreamingService handles message streaming to CLI clients
service StreamingService {
  // ListStreams returns all streams the user has access to
  rpc ListStreams(ListStreamsRequest) returns (ListStreamsResponse);
  
  // GetStreamKey retrieves the decryption key for a stream
  rpc GetStreamKey(GetStreamKeyRequest) returns (GetStreamKeyResponse);
  
  // OpenStream opens a stream and sends messages to the client
  rpc OpenStream(OpenStreamRequest) returns (stream StreamMessage);
}

// ListStreamsRequest requests a list of accessible streams
message ListStreamsRequest {
  // No parameters needed (user identified from auth context)
}

// ListStreamsResponse contains the list of streams
message ListStreamsResponse {
  repeated StreamInfo streams = 1;
}

// StreamInfo contains metadata about a stream
message StreamInfo {
  string stream_id = 1;
  string name = 2;
  string description = 3;
  int32 retention_days = 4;      // Retention period in days
  string status = 5;              // active, paused, deleted
  int64 created_at = 6;           // Timestamp in nanoseconds
  int64 updated_at = 7;           // Timestamp in nanoseconds
}

// GetStreamKeyRequest requests the decryption key for a stream
message GetStreamKeyRequest {
  string stream_id = 1;
}

// GetStreamKeyResponse contains the decryption key
message GetStreamKeyResponse {
  bytes private_key = 1;          // Stream private key (encrypted in transit)
  string key_id = 2;              // Key ID for key rotation support
}

// OpenStreamRequest requests to open a stream
message OpenStreamRequest {
  string stream_id = 1;
  
  // Start mode determines where to start streaming from
  StreamStartMode start_mode = 2;
  
  // Start parameters (used based on start_mode)
  int64 start_timestamp_ns = 3;    // For FROM_TIMESTAMP mode
  int64 start_offset = 4;          // For FROM_OFFSET mode
}

// StreamStartMode determines where to start streaming
enum StreamStartMode {
  STREAM_START_MODE_UNSPECIFIED = 0;
  STREAM_START_MODE_LIVE = 1;           // Start from latest (live streaming)
  STREAM_START_MODE_FROM_TIMESTAMP = 2;  // Start from specific timestamp
  STREAM_START_MODE_FROM_OFFSET = 3;    // Start from specific offset
}

// StreamMessage is a message sent to the client
message StreamMessage {
  // Message data (encrypted, client must decrypt)
  bytes encrypted_symmetric_key = 1;   // Symmetric key encrypted with stream public key
  bytes encrypted_payload = 2;          // MirroredRequest encrypted with symmetric key
  bytes iv = 3;                         // Initialization vector
  bytes auth_tag = 4;                   // Authentication tag
  
  // Metadata
  int64 offset = 5;                     // Message offset in stream
  int64 timestamp_ns = 6;               // Message timestamp
  string message_id = 7;                // Unique message ID
}

